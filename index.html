<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم مدیریت کسب‌وکار</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif; }
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css');
        .icon-center { display: inline-flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // SVG Icons - inline for simplicity
        const Plus = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14M12 5v14"/></svg>;
        const Edit2 = () => <svg className="icon-center" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>;
        const Trash2 = () => <svg className="icon-center" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const Settings = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/></svg>;
        const Moon = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
        const Sun = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>;
        const Save = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const X = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const Search = () => <svg className="icon-center" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Package = ({size}) => <svg className="icon-center" width={size || "20"} height={size || "20"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m7.5 4.27 9 5.15M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16ZM3.3 7l8.7 5 8.7-5M12 22V12"/></svg>;
        const Briefcase = ({size}) => <svg className="icon-center" width={size || "20"} height={size || "20"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="14" x="2" y="7" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const Wrench = ({size}) => <svg className="icon-center" width={size || "20"} height={size || "20"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>;
        const TrendingUp = () => <svg className="icon-center" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
        const Boxes = ({size}) => <svg className="icon-center" width={size || "20"} height={size || "20"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2.97 12.92A2 2 0 0 0 2 14.63v3.24a2 2 0 0 0 .97 1.71l3 1.8a2 2 0 0 0 2.06 0L12 19v-5.5l-5-3-4.03 2.42ZM7 16.5l-4.74-2.85M7 16.5l5-3M7 16.5v5.17M12 13.5V19l3.97 2.38a2 2 0 0 0 2.06 0l3-1.8a2 2 0 0 0 .97-1.71v-3.24a2 2 0 0 0-.97-1.71L17 10.5l-5 3ZM17 16.5l-5-3M17 16.5l4.74-2.85M17 16.5v5.17M7.97 4.42A2 2 0 0 0 7 6.13v4.37l5 3 5-3V6.13a2 2 0 0 0-.97-1.71l-3-1.8a2 2 0 0 0-2.06 0l-3 1.8ZM12 8L7.26 5.15M12 8l4.74-2.85M12 13.5V8"/></svg>;
        const ChevronDown = () => <svg className="icon-center" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m6 9 6 6 6-6"/></svg>;
        const ChevronUp = () => <svg className="icon-center" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m18 15-6-6-6 6"/></svg>;

        function App() {
          const [products, setProducts] = useState([]);
          const [services, setServices] = useState([]);
          const [materials, setMaterials] = useState([]);
          const [equipment, setEquipment] = useState([]);
          const [activeTab, setActiveTab] = useState('products');
          const [showModal, setShowModal] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [editingItem, setEditingItem] = useState(null);
          const [theme, setTheme] = useState('dark');
          const [primaryColor, setPrimaryColor] = useState('#3b82f6');
          const [loading, setLoading] = useState(true);
          const [expandedProduct, setExpandedProduct] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          
          const [formData, setFormData] = useState({
            title: '',
            description: '',
            price: '',
            category: '',
            materials: [],
            profitMargin: 20
          });

          const [materialForm, setMaterialForm] = useState({
            title: '',
            unit: 'عدد',
            pricePerUnit: '',
            category: ''
          });

          const [equipmentForm, setEquipmentForm] = useState({
            title: '',
            brand: '',
            model: '',
            purchaseDate: '',
            purchasePrice: '',
            maintenanceSchedule: '',
            notes: ''
          });

          useEffect(() => {
            loadData();
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedColor = localStorage.getItem('primaryColor') || '#3b82f6';
            setTheme(savedTheme);
            setPrimaryColor(savedColor);
          }, []);

          const loadData = () => {
            try {
              const saved = localStorage.getItem('businessData');
              if (saved) {
                const data = JSON.parse(saved);
                setProducts(data.products || []);
                setServices(data.services || []);
                setMaterials(data.materials || []);
                setEquipment(data.equipment || []);
              } else {
                // Default materials
                setMaterials([
                  { id: 1, title: 'جوهر سابلیمیشن (100ml)', unit: 'میلی‌لیتر', pricePerUnit: '15000', category: 'مواد چاپ' },
                  { id: 2, title: 'پارچه پلی‌استر (متر)', unit: 'متر', pricePerUnit: '45000', category: 'پارچه' },
                  { id: 3, title: 'کاغذ سابلیمیشن A4', unit: 'برگ', pricePerUnit: '2000', category: 'مواد چاپ' },
                  { id: 4, title: 'لیبل برچسب', unit: 'عدد', pricePerUnit: '500', category: 'بسته‌بندی' },
                  { id: 5, title: 'ماگ سفید ساده', unit: 'عدد', pricePerUnit: '12000', category: 'محصول خام' },
                  { id: 6, title: 'تیشرت سفید کتان', unit: 'عدد', pricePerUnit: '35000', category: 'محصول خام' },
                  { id: 7, title: 'بج پین', unit: 'عدد', pricePerUnit: '1500', category: 'محصول خام' }
                ]);
              }
            } catch (error) {
              console.error('خطا در بارگذاری داده:', error);
            }
            setLoading(false);
          };

          const saveAllData = (newProducts, newServices, newMaterials, newEquipment) => {
            const data = {
              products: newProducts,
              services: newServices,
              materials: newMaterials,
              equipment: newEquipment
            };
            localStorage.setItem('businessData', JSON.stringify(data));
          };

          const saveProducts = (data) => {
            setProducts(data);
            saveAllData(data, services, materials, equipment);
          };

          const saveServices = (data) => {
            setServices(data);
            saveAllData(products, data, materials, equipment);
          };

          const saveMaterials = (data) => {
            setMaterials(data);
            saveAllData(products, services, data, equipment);
          };

          const saveEquipment = (data) => {
            setEquipment(data);
            saveAllData(products, services, materials, data);
          };

          const calculateProductCost = (productMaterials) => {
            if (!productMaterials || productMaterials.length === 0) return 0;
            return productMaterials.reduce((total, pm) => {
              const material = materials.find(m => String(m.id) === String(pm.materialId));
              if (material && material.pricePerUnit && pm.quantity) {
                return total + (parseFloat(material.pricePerUnit) * parseFloat(pm.quantity));
              }
              return total;
            }, 0);
          };

          const handleAddProduct = () => {
            if (!formData.title.trim()) return;
            
            const newProduct = {
              id: Date.now(),
              title: formData.title,
              description: formData.description,
              category: formData.category,
              materials: formData.materials,
              price: formData.price,
              profitMargin: formData.profitMargin,
              createdAt: new Date().toISOString()
            };
            
            saveProducts([...products, newProduct]);
            resetForm();
            setShowModal(false);
          };

          const handleUpdateProduct = () => {
            if (!formData.title.trim()) return;
            
            const updatedProducts = products.map(item => 
              item.id === editingItem.id 
                ? { 
                    ...item, 
                    title: formData.title,
                    description: formData.description,
                    category: formData.category,
                    materials: formData.materials,
                    price: formData.price,
                    profitMargin: formData.profitMargin,
                    updatedAt: new Date().toISOString()
                  }
                : item
            );
            
            saveProducts(updatedProducts);
            resetForm();
            setShowModal(false);
            setEditingItem(null);
          };

          const handleAddService = () => {
            if (!formData.title.trim()) return;
            
            const newService = {
              id: Date.now(),
              title: formData.title,
              description: formData.description,
              price: formData.price,
              category: formData.category,
              createdAt: new Date().toISOString()
            };
            
            saveServices([...services, newService]);
            resetForm();
            setShowModal(false);
          };

          const handleUpdateService = () => {
            if (!formData.title.trim()) return;
            
            const updatedServices = services.map(item => 
              item.id === editingItem.id 
                ? { 
                    ...item, 
                    title: formData.title,
                    description: formData.description,
                    price: formData.price,
                    category: formData.category,
                    updatedAt: new Date().toISOString()
                  }
                : item
            );
            
            saveServices(updatedServices);
            resetForm();
            setShowModal(false);
            setEditingItem(null);
          };

          const handleAddMaterial = () => {
            if (!materialForm.title.trim() || !materialForm.pricePerUnit) return;
            
            const newMaterial = {
              id: Date.now(),
              title: materialForm.title,
              unit: materialForm.unit,
              pricePerUnit: materialForm.pricePerUnit,
              category: materialForm.category,
              createdAt: new Date().toISOString()
            };
            
            saveMaterials([...materials, newMaterial]);
            setMaterialForm({ title: '', unit: 'عدد', pricePerUnit: '', category: '' });
            setShowModal(false);
          };

          const handleUpdateMaterial = () => {
            if (!materialForm.title.trim() || !materialForm.pricePerUnit) return;
            
            const updatedMaterials = materials.map(item => 
              item.id === editingItem.id 
                ? { 
                    ...item, 
                    ...materialForm,
                    updatedAt: new Date().toISOString()
                  }
                : item
            );
            
            saveMaterials(updatedMaterials);
            setMaterialForm({ title: '', unit: 'عدد', pricePerUnit: '', category: '' });
            setShowModal(false);
            setEditingItem(null);
          };

          const handleAddEquipment = () => {
            if (!equipmentForm.title.trim()) return;
            
            const newEquip = {
              id: Date.now(),
              ...equipmentForm,
              createdAt: new Date().toISOString()
            };
            
            saveEquipment([...equipment, newEquip]);
            setEquipmentForm({ title: '', brand: '', model: '', purchaseDate: '', purchasePrice: '', maintenanceSchedule: '', notes: '' });
            setShowModal(false);
          };

          const handleUpdateEquipment = () => {
            if (!equipmentForm.title.trim()) return;
            
            const updatedEquipment = equipment.map(item => 
              item.id === editingItem.id 
                ? { 
                    ...item, 
                    ...equipmentForm,
                    updatedAt: new Date().toISOString()
                  }
                : item
            );
            
            saveEquipment(updatedEquipment);
            setEquipmentForm({ title: '', brand: '', model: '', purchaseDate: '', purchasePrice: '', maintenanceSchedule: '', notes: '' });
            setShowModal(false);
            setEditingItem(null);
          };

          const handleDelete = (id, type) => {
            if (confirm('آیا از حذف این مورد اطمینان دارید؟')) {
              if (type === 'product') saveProducts(products.filter(item => item.id !== id));
              if (type === 'service') saveServices(services.filter(item => item.id !== id));
              if (type === 'material') saveMaterials(materials.filter(item => item.id !== id));
              if (type === 'equipment') saveEquipment(equipment.filter(item => item.id !== id));
            }
          };

          const handleEdit = (item, type) => {
            setEditingItem(item);
            if (type === 'product') {
              setFormData({
                title: item.title,
                description: item.description,
                price: item.price,
                category: item.category,
                materials: item.materials || [],
                profitMargin: item.profitMargin || 20
              });
            } else if (type === 'service') {
              setFormData({
                title: item.title,
                description: item.description,
                price: item.price,
                category: item.category,
                materials: [],
                profitMargin: 20
              });
            } else if (type === 'material') {
              setMaterialForm({
                title: item.title,
                unit: item.unit,
                pricePerUnit: item.pricePerUnit,
                category: item.category
              });
            } else if (type === 'equipment') {
              setEquipmentForm({
                title: item.title,
                brand: item.brand || '',
                model: item.model || '',
                purchaseDate: item.purchaseDate || '',
                purchasePrice: item.purchasePrice || '',
                maintenanceSchedule: item.maintenanceSchedule || '',
                notes: item.notes || ''
              });
            }
            setShowModal(true);
          };

          const resetForm = () => {
            setFormData({
              title: '',
              description: '',
              price: '',
              category: '',
              materials: [],
              profitMargin: 20
            });
            setEditingItem(null);
          };

          const addMaterialToProduct = () => {
            setFormData({
              ...formData,
              materials: [...formData.materials, { materialId: '', quantity: '' }]
            });
          };

          const updateProductMaterial = (index, field, value) => {
            const updated = [...formData.materials];
            updated[index][field] = value;
            setFormData({ ...formData, materials: updated });
          };

          const removeProductMaterial = (index) => {
            setFormData({
              ...formData,
              materials: formData.materials.filter((_, i) => i !== index)
            });
          };

          const saveSettings = () => {
            localStorage.setItem('theme', theme);
            localStorage.setItem('primaryColor', primaryColor);
            setShowSettings(false);
          };

          const filterItems = (items) => {
            if (!searchQuery) return items;
            return items.filter(item => 
              item.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
              (item.category && item.category.toLowerCase().includes(searchQuery.toLowerCase())) ||
              (item.description && item.description.toLowerCase().includes(searchQuery.toLowerCase()))
            );
          };

          const bgClass = theme === 'dark' ? 'bg-gray-900' : 'bg-gray-50';
          const cardBg = theme === 'dark' ? 'bg-gray-800' : 'bg-white';
          const textClass = theme === 'dark' ? 'text-gray-100' : 'text-gray-900';
          const textSecondary = theme === 'dark' ? 'text-gray-400' : 'text-gray-600';
          const borderClass = theme === 'dark' ? 'border-gray-700' : 'border-gray-200';
          const inputBg = theme === 'dark' ? 'bg-gray-700' : 'bg-gray-100';

          const currentCost = activeTab === 'products' ? calculateProductCost(formData.materials) : 0;
          const suggestedPrice = currentCost > 0 ? (currentCost * (1 + formData.profitMargin / 100)).toFixed(0) : '';

          const filteredProducts = filterItems(products);
          const filteredServices = filterItems(services);
          const filteredMaterials = filterItems(materials);
          const filteredEquipment = filterItems(equipment);

          if (loading) {
            return (
              <div className={`min-h-screen ${bgClass} flex items-center justify-center`}>
                <div className="animate-spin rounded-full h-12 w-12 border-b-2" style={{ borderColor: primaryColor }}></div>
              </div>
            );
          }

          return (
            <div className={`min-h-screen ${bgClass} ${textClass}`} style={{ transition: 'all 0.3s' }}>
              {/* Header */}
              <header className={`${cardBg} border-b ${borderClass} sticky top-0 z-40`} style={{ backdropFilter: 'blur(12px)', backgroundColor: theme === 'dark' ? 'rgba(31, 41, 55, 0.9)' : 'rgba(255, 255, 255, 0.9)' }}>
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: primaryColor }}>
                        <TrendingUp />
                      </div>
                      <h1 className="text-2xl font-bold">سیستم مدیریت کسب‌وکار</h1>
                    </div>
                    
                    <div className="flex items-center gap-2">
                      <button onClick={() => { setShowModal(true); resetForm(); }} className="px-4 py-2 rounded-lg text-white font-medium flex items-center gap-2" style={{ backgroundColor: primaryColor }}>
                        <Plus />
                        افزودن
                      </button>
                      
                      <button onClick={() => setShowSettings(true)} className={`p-2 rounded-lg ${inputBg}`}>
                        <Settings />
                      </button>
                      
                      <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className={`p-2 rounded-lg ${inputBg}`}>
                        {theme === 'dark' ? <Sun /> : <Moon />}
                      </button>
                    </div>
                  </div>

                  {/* Tabs */}
                  <div className="flex gap-2 overflow-x-auto pb-2">
                    {[
                      { id: 'products', label: 'محصولات', Icon: Package, count: products.length },
                      { id: 'services', label: 'خدمات', Icon: Briefcase, count: services.length },
                      { id: 'materials', label: 'مواد اولیه', Icon: Boxes, count: materials.length },
                      { id: 'equipment', label: 'تجهیزات', Icon: Wrench, count: equipment.length }
                    ].map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => { setActiveTab(tab.id); setSearchQuery(''); }}
                        className={`px-4 py-2 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === tab.id ? 'text-white' : inputBg}`}
                        style={activeTab === tab.id ? { backgroundColor: primaryColor } : {}}
                      >
                        <tab.Icon />
                        {tab.label}
                        <span className={`px-2 py-0.5 rounded-full text-xs ${activeTab === tab.id ? 'bg-white bg-opacity-20' : 'bg-gray-600 bg-opacity-30'}`}>
                          {tab.count}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>
              </header>

              {/* Main */}
              <main className="max-w-7xl mx-auto px-4 py-8">
                {/* Search */}
                <div className="mb-6">
                  <div className={`${inputBg} rounded-lg px-4 py-3 flex items-center gap-3 border ${borderClass}`}>
                    <Search />
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder={`جستجو در ${activeTab === 'products' ? 'محصولات' : activeTab === 'services' ? 'خدمات' : activeTab === 'materials' ? 'مواد اولیه' : 'تجهیزات'}...`}
                      className={`flex-1 bg-transparent outline-none ${textClass}`}
                    />
                  </div>
                </div>

                {/* Products */}
                {activeTab === 'products' && (
                  <>
                    {filteredProducts.length === 0 && (
                      <div className={`${cardBg} rounded-2xl p-12 text-center border ${borderClass}`}>
                        <Package size="64" />
                        <p className={`${textSecondary} mt-4`}>{searchQuery ? 'محصولی یافت نشد' : 'هنوز محصولی اضافه نشده است'}</p>
                      </div>
                    )}
                    
                    {filteredProducts.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredProducts.map(product => {
                          const cost = calculateProductCost(product.materials);
                          const price = parseFloat(product.price) || 0;
                          const profit = price - cost;
                          const profitPercent = cost > 0 ? (profit / cost) * 100 : 0;
                          const isExpanded = expandedProduct === product.id;

                          return (
                            <div key={product.id} className={`${cardBg} rounded-xl p-5 border ${borderClass} group hover:shadow-xl transition-all`}>
                              <div className="flex items-start justify-between mb-3">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-2">
                                    <Package />
                                    <h3 className="font-bold text-lg">{product.title}</h3>
                                  </div>
                                  {product.category && (
                                    <span className={`${inputBg} px-3 py-1 rounded-full text-xs`}>{product.category}</span>
                                  )}
                                </div>
                                
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                  <button onClick={() => handleEdit(product, 'product')} className={`p-2 rounded-lg ${inputBg}`}>
                                    <Edit2 />
                                  </button>
                                  <button onClick={() => handleDelete(product.id, 'product')} className={`p-2 rounded-lg ${inputBg} hover:bg-red-500 hover:text-white`}>
                                    <Trash2 />
                                  </button>
                                </div>
                              </div>
                              
                              {product.description && (
                                <p className={`${textSecondary} text-sm mb-3`}>{product.description}</p>
                              )}

                              <div className={`${inputBg} rounded-lg p-3 mb-3 space-y-2`}>
                                <div className="flex justify-between text-sm">
                                  <span className={textSecondary}>هزینه تمام شده:</span>
                                  <span className="font-medium">{cost.toLocaleString('fa-IR')} تومان</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                  <span className={textSecondary}>قیمت فروش:</span>
                                  <span className="font-bold" style={{ color: primaryColor }}>
                                    {price.toLocaleString('fa-IR')} تومان
                                  </span>
                                </div>
                                <div className="flex justify-between text-sm pt-2 border-t" style={{ borderColor: theme === 'dark' ? '#4b5563' : '#d1d5db' }}>
                                  <span className={textSecondary}>سود:</span>
                                  <span className={`font-bold ${profit >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                                    {profit.toLocaleString('fa-IR')} تومان ({profitPercent.toFixed(1)}%)
                                  </span>
                                </div>
                              </div>

                              {product.materials && product.materials.length > 0 && (
                                <div>
                                  <button onClick={() => setExpandedProduct(isExpanded ? null : product.id)} className={`w-full flex items-center justify-between ${inputBg} px-3 py-2 rounded-lg text-sm font-medium`}>
                                    <span>مواد اولیه ({product.materials.length})</span>
                                    {isExpanded ? <ChevronUp /> : <ChevronDown />}
                                  </button>
                                  
                                  {isExpanded && (
                                    <div className={`mt-2 ${inputBg} rounded-lg p-3 space-y-2`}>
                                      {product.materials.map((pm, idx) => {
                                        const material = materials.find(m => String(m.id) === String(pm.materialId));
                                        if (!material) return (
                                          <div key={idx} className="text-xs text-red-500">ماده اولیه حذف شده</div>
                                        );
                                        const itemCost = parseFloat(material.pricePerUnit) * parseFloat(pm.quantity);
                                        return (
                                          <div key={idx} className="text-xs flex justify-between">
                                            <span className={textSecondary}>
                                              {material.title} × {pm.quantity} {material.unit}
                                            </span>
                                            <span className="font-medium">{itemCost.toLocaleString('fa-IR')} تومان</span>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </>
                )}

                {/* Services */}
                {activeTab === 'services' && (
                  <>
                    {filteredServices.length === 0 && (
                      <div className={`${cardBg} rounded-2xl p-12 text-center border ${borderClass}`}>
                        <Briefcase size="64" />
                        <p className={`${textSecondary} mt-4`}>{searchQuery ? 'خدمتی یافت نشد' : 'هنوز خدمتی اضافه نشده است'}</p>
                      </div>
                    )}

                    {filteredServices.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredServices.map(service => (
                          <div key={service.id} className={`${cardBg} rounded-xl p-5 border ${borderClass} group hover:shadow-xl transition-all`}>
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                  <Briefcase />
                                  <h3 className="font-bold text-lg">{service.title}</h3>
                                </div>
                                {service.category && (
                                  <span className={`${inputBg} px-3 py-1 rounded-full text-xs`}>{service.category}</span>
                                )}
                              </div>
                              
                              <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => handleEdit(service, 'service')} className={`p-2 rounded-lg ${inputBg}`}>
                                  <Edit2 />
                                </button>
                                <button onClick={() => handleDelete(service.id, 'service')} className={`p-2 rounded-lg ${inputBg} hover:bg-red-500 hover:text-white`}>
                                  <Trash2 />
                                </button>
                              </div>
                            </div>
                            
                            {service.description && (
                              <p className={`${textSecondary} text-sm mb-3`}>{service.description}</p>
                            )}
                            
                            {service.price && (
                              <div className="pt-3 border-t" style={{ borderColor: theme === 'dark' ? '#374151' : '#e5e7eb' }}>
                                <span className="font-bold text-lg" style={{ color: primaryColor }}>
                                  {parseFloat(service.price).toLocaleString('fa-IR')} تومان
                                </span>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </>
                )}

                {/* Materials */}
                {activeTab === 'materials' && (
                  <>
                    {filteredMaterials.length === 0 && (
                      <div className={`${cardBg} rounded-2xl p-12 text-center border ${borderClass}`}>
                        <Boxes size="64" />
                        <p className={`${textSecondary} mt-4`}>{searchQuery ? 'ماده اولیه‌ای یافت نشد' : 'هنوز ماده اولیه‌ای اضافه نشده است'}</p>
                      </div>
                    )}

                    {filteredMaterials.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {filteredMaterials.map(material => (
                          <div key={material.id} className={`${cardBg} rounded-xl p-5 border ${borderClass} group hover:shadow-xl transition-all`}>
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                  <Boxes />
                                  <h3 className="font-bold">{material.title}</h3>
                                </div>
                                {material.category && (
                                  <span className={`${inputBg} px-2 py-1 rounded-full text-xs`}>{material.category}</span>
                                )}
                              </div>
                              
                              <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => handleEdit(material, 'material')} className={`p-2 rounded-lg ${inputBg}`}>
                                  <Edit2 />
                                </button>
                                <button onClick={() => handleDelete(material.id, 'material')} className={`p-2 rounded-lg ${inputBg} hover:bg-red-500 hover:text-white`}>
                                  <Trash2 />
                                </button>
                              </div>
                            </div>
                            
                            <div className={`${inputBg} rounded-lg p-3 text-center`}>
                              <div className="font-bold text-xl mb-1" style={{ color: primaryColor }}>
                                {parseFloat(material.pricePerUnit).toLocaleString('fa-IR')}
                              </div>
                              <div className={`${textSecondary} text-sm`}>
                                تومان / {material.unit}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </>
                )}

                {/* Equipment */}
                {activeTab === 'equipment' && (
                  <>
                    {filteredEquipment.length === 0 && (
                      <div className={`${cardBg} rounded-2xl p-12 text-center border ${borderClass}`}>
                        <Wrench size="64" />
                        <p className={`${textSecondary} mt-4`}>{searchQuery ? 'تجهیزاتی یافت نشد' : 'هنوز تجهیزاتی اضافه نشده است'}</p>
                      </div>
                    )}

                    {filteredEquipment.length > 0 && (
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredEquipment.map(equip => (
                          <div key={equip.id} className={`${cardBg} rounded-xl p-5 border ${borderClass} group hover:shadow-xl transition-all`}>
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-2">
                                  <Wrench />
                                  <h3 className="font-bold text-lg">{equip.title}</h3>
                                </div>
                                {(equip.brand || equip.model) && (
                                  <p className={`${textSecondary} text-sm`}>{equip.brand} {equip.model}</p>
                                )}
                              </div>
                              
                              <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => handleEdit(equip, 'equipment')} className={`p-2 rounded-lg ${inputBg}`}>
                                  <Edit2 />
                                </button>
                                <button onClick={() => handleDelete(equip.id, 'equipment')} className={`p-2 rounded-lg ${inputBg} hover:bg-red-500 hover:text-white`}>
                                  <Trash2 />
                                </button>
                              </div>
                            </div>
                            
                            <div className="space-y-2">
                              {equip.purchaseDate && (
                                <div className="flex justify-between text-sm">
                                  <span className={textSecondary}>تاریخ خرید:</span>
                                  <span>{new Date(equip.purchaseDate).toLocaleDateString('fa-IR')}</span>
                                </div>
                              )}
                              {equip.purchasePrice && (
                                <div className="flex justify-between text-sm">
                                  <span className={textSecondary}>قیمت خرید:</span>
                                  <span className="font-medium">{parseFloat(equip.purchasePrice).toLocaleString('fa-IR')} تومان</span>
                                </div>
                              )}
                              {equip.maintenanceSchedule && (
                                <div className="flex justify-between text-sm">
                                  <span className={textSecondary}>نگهداری:</span>
                                  <span>{equip.maintenanceSchedule}</span>
                                </div>
                              )}
                            </div>
                            
                            {equip.notes && (
                              <p className={`${textSecondary} text-sm pt-3 mt-3 border-t`} style={{ borderColor: theme === 'dark' ? '#374151' : '#e5e7eb' }}>
                                {equip.notes}
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </>
                )}
              </main>

              {/* Modal */}
              {showModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                  <div className={`${cardBg} rounded-2xl max-w-2xl w-full p-6 shadow-2xl my-8`}>
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-xl font-bold">
                        {editingItem ? 'ویرایش' : 'افزودن'} {
                          activeTab === 'products' ? 'محصول' :
                          activeTab === 'services' ? 'خدمت' :
                          activeTab === 'materials' ? 'ماده اولیه' : 'تجهیزات'
                        }
                      </h3>
                      <button onClick={() => { setShowModal(false); resetForm(); }} className={`p-2 rounded-lg ${inputBg}`}>
                        <X />
                      </button>
                    </div>
                    
                    {(activeTab === 'products' || activeTab === 'services') && (
                      <div className="space-y-4">
                        <div>
                          <label className="block mb-2 text-sm font-medium">عنوان *</label>
                          <input
                            type="text"
                            value={formData.title}
                            onChange={(e) => setFormData({...formData, title: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="عنوان را وارد کنید"
                          />
                        </div>

                        <div>
                          <label className="block mb-2 text-sm font-medium">دسته‌بندی</label>
                          <input
                            type="text"
                            value={formData.category}
                            onChange={(e) => setFormData({...formData, category: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="دسته‌بندی"
                          />
                        </div>

                        {activeTab === 'products' && (
                          <>
                            <div className={`${inputBg} rounded-lg p-4 border ${borderClass}`}>
                              <div className="flex items-center justify-between mb-3">
                                <label className="text-sm font-medium">مواد اولیه مورد نیاز</label>
                                <button
                                  onClick={addMaterialToProduct}
                                  className="px-3 py-1 rounded-lg text-white text-sm font-medium flex items-center gap-1"
                                  style={{ backgroundColor: primaryColor }}
                                >
                                  <Plus />
                                  افزودن
                                </button>
                              </div>
                              
                              {formData.materials.length === 0 ? (
                                <p className={`${textSecondary} text-sm text-center py-4`}>هنوز ماده اولیه‌ای اضافه نشده</p>
                              ) : (
                                <div className="space-y-2">
                                  {formData.materials.map((pm, index) => (
                                    <div key={index} className="flex gap-2 items-center">
                                      <select
                                        value={pm.materialId}
                                        onChange={(e) => updateProductMaterial(index, 'materialId', e.target.value)}
                                        className={`flex-1 px-3 py-2 rounded-lg border ${borderClass} text-sm outline-none`}
                                        style={{ backgroundColor: theme === 'dark' ? '#4b5563' : 'white' }}
                                      >
                                        <option value="">انتخاب ماده اولیه</option>
                                        {materials.map(mat => (
                                          <option key={mat.id} value={mat.id}>
                                            {mat.title} ({parseFloat(mat.pricePerUnit).toLocaleString('fa-IR')} تومان / {mat.unit})
                                          </option>
                                        ))}
                                      </select>
                                      <input
                                        type="number"
                                        value={pm.quantity}
                                        onChange={(e) => updateProductMaterial(index, 'quantity', e.target.value)}
                                        className={`w-24 px-3 py-2 rounded-lg border ${borderClass} text-sm outline-none`}
                                        style={{ backgroundColor: theme === 'dark' ? '#4b5563' : 'white' }}
                                        placeholder="تعداد"
                                        min="0"
                                        step="0.01"
                                      />
                                      <button
                                        onClick={() => removeProductMaterial(index)}
                                        className={`p-2 rounded-lg ${inputBg} hover:bg-red-500 hover:text-white`}
                                      >
                                        <Trash2 />
                                      </button>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>

                            {currentCost > 0 && (
                              <div className={`${inputBg} rounded-lg p-4 border ${borderClass} space-y-3`}>
                                <div className="flex items-center justify-between">
                                  <span className="text-sm font-medium">هزینه تمام شده:</span>
                                  <span className="font-bold" style={{ color: primaryColor }}>
                                    {currentCost.toLocaleString('fa-IR')} تومان
                                  </span>
                                </div>
                                
                                <div>
                                  <label className="block mb-2 text-sm font-medium">حاشیه سود (%)</label>
                                  <input
                                    type="number"
                                    value={formData.profitMargin}
                                    onChange={(e) => setFormData({...formData, profitMargin: parseFloat(e.target.value) || 0})}
                                    className={`w-full px-4 py-2 rounded-lg border ${borderClass} outline-none`}
                                    style={{ backgroundColor: theme === 'dark' ? '#4b5563' : 'white' }}
                                    min="0"
                                    step="1"
                                  />
                                </div>

                                <div className="flex items-center justify-between pt-2 border-t" style={{ borderColor: theme === 'dark' ? '#4b5563' : '#e5e7eb' }}>
                                  <span className="text-sm font-medium">قیمت پیشنهادی:</span>
                                  <span className="font-bold text-lg" style={{ color: primaryColor }}>
                                    {suggestedPrice ? parseFloat(suggestedPrice).toLocaleString('fa-IR') : '0'} تومان
                                  </span>
                                </div>
                              </div>
                            )}
                          </>
                        )}

                        <div>
                          <label className="block mb-2 text-sm font-medium">قیمت فروش (تومان) *</label>
                          <input
                            type="number"
                            value={formData.price}
                            onChange={(e) => setFormData({...formData, price: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder={suggestedPrice || "قیمت"}
                            min="0"
                          />
                        </div>

                        <div>
                          <label className="block mb-2 text-sm font-medium">توضیحات</label>
                          <textarea
                            value={formData.description}
                            onChange={(e) => setFormData({...formData, description: e.target.value})}
                            rows="3"
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none resize-none`}
                            placeholder="توضیحات تکمیلی"
                          />
                        </div>

                        <button
                          onClick={activeTab === 'products' ? (editingItem ? handleUpdateProduct : handleAddProduct) : (editingItem ? handleUpdateService : handleAddService)}
                          className="w-full py-3 rounded-lg text-white font-medium"
                          style={{ backgroundColor: primaryColor }}
                        >
                          {editingItem ? 'بروزرسانی' : 'افزودن'}
                        </button>
                      </div>
                    )}

                    {activeTab === 'materials' && (
                      <div className="space-y-4">
                        <div>
                          <label className="block mb-2 text-sm font-medium">نام ماده اولیه *</label>
                          <input
                            type="text"
                            value={materialForm.title}
                            onChange={(e) => setMaterialForm({...materialForm, title: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="مثال: جوهر سابلیمیشن، پارچه"
                          />
                        </div>

                        <div>
                          <label className="block mb-2 text-sm font-medium">دسته‌بندی</label>
                          <input
                            type="text"
                            value={materialForm.category}
                            onChange={(e) => setMaterialForm({...materialForm, category: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="مواد چاپ، پارچه، محصول خام"
                          />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block mb-2 text-sm font-medium">واحد *</label>
                            <select
                              value={materialForm.unit}
                              onChange={(e) => setMaterialForm({...materialForm, unit: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            >
                              <option value="عدد">عدد</option>
                              <option value="کیلوگرم">کیلوگرم</option>
                              <option value="گرم">گرم</option>
                              <option value="متر">متر</option>
                              <option value="لیتر">لیتر</option>
                              <option value="میلی‌لیتر">میلی‌لیتر</option>
                              <option value="برگ">برگ</option>
                              <option value="بسته">بسته</option>
                            </select>
                          </div>

                          <div>
                            <label className="block mb-2 text-sm font-medium">قیمت (تومان) *</label>
                            <input
                              type="number"
                              value={materialForm.pricePerUnit}
                              onChange={(e) => setMaterialForm({...materialForm, pricePerUnit: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                              placeholder="قیمت"
                              min="0"
                            />
                          </div>
                        </div>

                        <button
                          onClick={editingItem ? handleUpdateMaterial : handleAddMaterial}
                          className="w-full py-3 rounded-lg text-white font-medium"
                          style={{ backgroundColor: primaryColor }}
                        >
                          {editingItem ? 'بروزرسانی' : 'افزودن'}
                        </button>
                      </div>
                    )}

                    {activeTab === 'equipment' && (
                      <div className="space-y-4">
                        <div>
                          <label className="block mb-2 text-sm font-medium">نام تجهیزات *</label>
                          <input
                            type="text"
                            value={equipmentForm.title}
                            onChange={(e) => setEquipmentForm({...equipmentForm, title: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="مثال: دستگاه پرس، چاپگر"
                          />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block mb-2 text-sm font-medium">برند</label>
                            <input
                              type="text"
                              value={equipmentForm.brand}
                              onChange={(e) => setEquipmentForm({...equipmentForm, brand: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                              placeholder="برند"
                            />
                          </div>

                          <div>
                            <label className="block mb-2 text-sm font-medium">مدل</label>
                            <input
                              type="text"
                              value={equipmentForm.model}
                              onChange={(e) => setEquipmentForm({...equipmentForm, model: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                              placeholder="مدل"
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block mb-2 text-sm font-medium">تاریخ خرید</label>
                            <input
                              type="date"
                              value={equipmentForm.purchaseDate}
                              onChange={(e) => setEquipmentForm({...equipmentForm, purchaseDate: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            />
                          </div>

                          <div>
                            <label className="block mb-2 text-sm font-medium">قیمت خرید</label>
                            <input
                              type="number"
                              value={equipmentForm.purchasePrice}
                              onChange={(e) => setEquipmentForm({...equipmentForm, purchasePrice: e.target.value})}
                              className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                              placeholder="تومان"
                              min="0"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block mb-2 text-sm font-medium">برنامه نگهداری</label>
                          <input
                            type="text"
                            value={equipmentForm.maintenanceSchedule}
                            onChange={(e) => setEquipmentForm({...equipmentForm, maintenanceSchedule: e.target.value})}
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none`}
                            placeholder="مثال: هر 6 ماه"
                          />
                        </div>

                        <div>
                          <label className="block mb-2 text-sm font-medium">یادداشت</label>
                          <textarea
                            value={equipmentForm.notes}
                            onChange={(e) => setEquipmentForm({...equipmentForm, notes: e.target.value})}
                            rows="3"
                            className={`w-full px-4 py-2 rounded-lg ${inputBg} border ${borderClass} outline-none resize-none`}
                            placeholder="یادداشت‌ها"
                          />
                        </div>

                        <button
                          onClick={editingItem ? handleUpdateEquipment : handleAddEquipment}
                          className="w-full py-3 rounded-lg text-white font-medium"
                          style={{ backgroundColor: primaryColor }}
                        >
                          {editingItem ? 'بروزرسانی' : 'افزودن'}
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Settings */}
              {showSettings && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className={`${cardBg} rounded-2xl max-w-md w-full p-6 shadow-2xl`}>
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-xl font-bold">تنظیمات</h3>
                      <button onClick={() => setShowSettings(false)} className={`p-2 rounded-lg ${inputBg}`}>
                        <X />
                      </button>
                    </div>
                    
                    <div className="space-y-6">
                      <div>
                        <label className="block mb-3 text-sm font-medium">تم</label>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setTheme('dark')}
                            className={`flex-1 py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 ${theme === 'dark' ? 'text-white' : inputBg}`}
                            style={theme === 'dark' ? { backgroundColor: primaryColor } : {}}
                          >
                            <Moon />
                            تیره
                          </button>
                          <button
                            onClick={() => setTheme('light')}
                            className={`flex-1 py-3 px-4 rounded-lg font-medium flex items-center justify-center gap-2 ${theme === 'light' ? 'text-white' : inputBg}`}
                            style={theme === 'light' ? { backgroundColor: primaryColor } : {}}
                          >
                            <Sun />
                            روشن
                          </button>
                        </div>
                      </div>

                      <div>
                        <label className="block mb-3 text-sm font-medium">رنگ اصلی</label>
                        <div className="grid grid-cols-5 gap-3">
                          {['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#06b6d4', '#6366f1', '#f97316', '#84cc16'].map(color => (
                            <button
                              key={color}
                              onClick={() => setPrimaryColor(color)}
                              className={`w-12 h-12 rounded-xl ${primaryColor === color ? 'ring-4 ring-offset-2' : ''}`}
                              style={{ 
                                backgroundColor: color,
                                ringColor: color,
                                ringOffsetColor: theme === 'dark' ? '#1f2937' : '#fff'
                              }}
                            />
                          ))}
                        </div>
                      </div>

                      <button
                        onClick={saveSettings}
                        className="w-full py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2"
                        style={{ backgroundColor: primaryColor }}
                      >
                        <Save />
                        ذخیره تنظیمات
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
